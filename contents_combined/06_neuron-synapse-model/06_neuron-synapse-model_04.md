## スパイク列と点過程モデル
これまで紹介したモデルでは，入力に対する膜電位などの時間変化に基づき発火が起こるかどうか，ということを考えてきた．この節では，発火が生じるまでの過程を考慮せず，発火の時間間隔 (inter-spike interval; ISI) の統計による現象論的モデルを考える．これを**Inter-spike interval (ISI)** モデルと呼ぶ．

神経細胞の発火のようなイベントがいつ（あるいはどこで）生じるのか，を記述する確率過程を**点過程** (point process) と呼ぶ．

ISIモデルは**点過程** (point process) という統計的モデルに基づいており，各モデルにはISIが従う分布の名称がついている．

時間に応じて変化する確率変数のことを**確率過程(stochastic process)** という．さらに確率過程の中で，連続時間軸上において離散的に生起する点事象の系列を**点過程(point process)** という．

この節では，使用頻度の高い **ポアソン過程 (Poisson process) モデル**，ポアソン過程モデルにおいて不応期を考慮した **死時間付きポアソン過程 (Poisson process with dead time, PPD) モデル**，皮質の定常発火においてポアソン過程モデルよりも当てはまりがよいとされる **ガンマ過程 (Gamma process) モデル**について説明する．

なお，SNNにおいて，ISIモデルは主に画像入力の際に**連続値からスパイク列へのエンコード**に用いられる．これに限らず入力として用いられることが多い．

この節は {cite:p}`Shimazaki_undated-ko`, {cite:p}`Pachitariu2010-pm` を参考に執筆した．

### ポアソン過程モデル
ポアソン過程 (Poisson process)は点過程の1つである．ポアソン過程モデルはスパイクの発生をポアソン過程でモデル化したもので，このモデルによって生じるスパイクをポアソンスパイク(Poisson spike)と呼ぶ．ポアソン過程では，時刻$t$までに起こった点の数$N(t)$はポアソン分布に従う．すなわち，点が起こる確率が強度$\lambda$のポアソン分布に従う場合, 時刻$t$までに事象が$n$回起こる確率は$P[N(t)=n]=\dfrac{(\lambda t)^{n}}{n !} e^{-\lambda t}$となる． 

ポアソン過程において点が起こる回数がポアソン分布に従うことは，ポアソン過程という名称の由来となっている．これを定義とする場合もあれば，次の4条件を満たす点過程をポアソン過程とするという定義もある．

1. 時刻0における初期の点の数は0 : $P[N(0)=0]=1$ 
2. $[t, t+\Delta t)$に点が1つ生じる確率 : $P[N(t+\Delta t)-N(t)=1]=\lambda(t)\Delta t+o(\Delta t)$
3. 微小時間$\Delta t$の間に点は2つ以上生じない : $P[N(t+\Delta t)-N(t)=2]=o(\Delta t)$
4. 任意の時点$t_1 < t_2 < \cdots< t_n$に対して，増分 $N(t_2)-N(t_1), N(t_3)-N(t_2), \cdots, N(t_n)-N(t_{n−1})$は互いに独立である．

ただし, $o(\cdot)$はLandauの記号(Landauのsmall o)であり, $o(x)$は$x\to 0$のとき，$o(x)/x\to 0$となる微小な量を表す．ポアソン過程に従ってスパイクが生じるとする場合，条件2の強度関数$\lambda(t)$は**発火率**を意味する (また実装において有用)．条件3は不応期より小さいタイムステップにおいては，1つのタイムステップにおいて1つしかスパイクは生じないということを表す．条件4はスパイクは独立に発生する，ということを意味する．また，これらの条件から$N(t)$の分布は強度母数$\lambda(t)$のポアソン分布に従うことが示せる．

強度関数(点がスパイクの場合，発火率)が$\lambda(t)=\lambda$ (定数)となる場合は点の時間間隔(点がスパイクの場合，ISI)の確率変数$T$が強度母数$\lambda$の **指数分布**に従う．なお，指数分布の確率密度関数は確率変数を$T$とするとき，

$$
\begin{equation}
f(t;\lambda )=\left\{{\begin{array}{ll}\lambda e^{-\lambda t}&(t\geq 0)\\0&(t<0)\end{array}}\right.
\end{equation}
$$

となる．このことは4条件とChapman-Kolmogorovの式により求められるが，ややこしいので, $P[N(t)=n]=\dfrac{(\lambda t)^{n}}{n !} e^{-\lambda t}$から導出できることを簡単に示す．指数分布の累積分布関数を$F(t; \lambda)$とすると，

$$
\begin{equation}
F(t; \lambda) = P(T< t)=1-P(T\geq t)=1-P(N(t)=0)=1-e^{-\lambda t}
\end{equation}
$$

となる．よって

$$
\begin{equation}
f(t; \lambda)=\frac{dF(t; \lambda)}{dt}=\lambda e^{-\lambda t}
\end{equation}
$$

が成り立つ．

### 定常ポアソン過程
ここからポアソン過程によるスパイクのシミュレーションを実装する．実装方法にはISIが指数分布に従うことを利用したものと，ポアソン過程の条件2を利用したものの2通りがある．実装は後者が楽で計算量も少ないが，後のガンマ過程のために前者の実装を先に行う．

#### ISIの累積により発火時刻を求める手法
ISIが指数分布に従うことを利用してポアソン過程モデルの実装を行う．まずISIを指数分布に従う乱数とする．次にISIを累積することで発火時刻を得る．最後に発火時間を整数値に丸めてindexとすることで$\{0, 1\}$のスパイク列が得られる．ISIの取得には`Random.randexp()`を用いる．この関数は scale 1の指数分布に従う乱数を返す．このscaleは指数分布の確率密度関数を$f(t; \frac{1}{\beta}) = \frac{1}{\beta} e^{-t/\beta}$とした際の$\beta = 1/\lambda$である(この時，平均は$\beta$となる)．よって発火率を`fr`(1/s), 単位時間を`dt`(s)としたときのISIは `isi = 1/(fr*dt) * randexp()`として得ることができる．

まず必要なパッケージを読み込む．

#### $\Delta t$ 間の発火確率が $\lambda\Delta t$ であることを利用する方法
次に2番目のポアソン過程モデルの実装を行う．こちらは$\lambda$を発火率とした場合, 区間 $[t, t+\Delta t)$ の間にポアソンスパイクが発生する確率は$\lambda \Delta t$となることを利用する．これはポアソン過程の条件だが，ポアソン分布から導けることを簡単に示しておく．事象が起こる確率が強度$\lambda$のポアソン分布に従う場合, 時刻$t$までに事象が$n$回起こる確率は$P[N(t)=n]=\dfrac{(\lambda t)^{n}}{n !} e^{-\lambda t}$となる．よって, 微小時間$\Delta t$において事象が$1$回起こる確率は

$$
\begin{equation}
P[N(\Delta t)=1]=\dfrac{\lambda \Delta t}{1 !} e^{-\lambda \Delta t}\simeq \lambda \Delta t+o(\Delta t)
\end{equation}
$$

となる．ただし, $e^{-\lambda \Delta t}$についてはTaylor展開による近似を行っている．このことから, 一様分布$U(0,1)$に従う乱数$\xi$を取得し, $\xi<\lambda dt$なら発火$(y=1)$, それ以外では$(y=0)$となるようにすればポアソンスパイクを実装できる．

### 非定常ポアソン過程
これまでの実装は発火率$\lambda$が一定であるとする，定常ポアソン過程 (homogeneous poisson process)であったが，ここからは発火率$\lambda(t)$が時間変化するとする**非定常ポアソン過程** (inhomogeneous poisson process)について考える．とはいえ，定常ポアソン過程における発火率を，時間についての関数で置き換えるだけで実装できる．以下は $\lambda(t)=\sin^2(\alpha t)$（ただし$\alpha$は定数）とした場合の実装である．

### 死時間付きポアソン過程モデル
ポアソン過程は簡易的で有用だが，不応期を考慮していない．そのため，時には生理的範疇を超えたバースト発火が起こる場合もある（複数のニューロンからの発火の重ね合わせ(superposition)であると考えることもできる．）．そこで，ポアソン過程において不応期のようなイベントの生起が起こらない **死時間** (dead time) \footnote{例えば，ガイガー・カウンター(Geiger counter)などの放射線の検出器には放射線の到達を機器の物理的特性として検出できない時間(つまり死時間)がある．そのため放射線の到達数がポアソン分布に従うとした場合，放射線測定装置のモデルとしてPPDが用いられる．}を考慮した**死時間付きポアソン過程** (Poisson process with dead time; PPD または dead time modified Poisson process) というモデルを導入する．

実装においてはLIFニューロンの時と同じような不応期の処理をする．つまり，現在が不応期かどうかを判断し，不応期なら発火を許可しないようにする．

### ガンマ過程モデル
ガンマ過程(gamma process)は点の時間間隔がガンマ分布に従うとするモデルである．ガンマ過程はポアソン過程よりも皮質における定常発火への当てはまりが良いとされている {cite:p}`Shinomoto2003-lz,Maimon2009-mb`．時間間隔の確率変数を$T$とした場合，ガンマ分布の確率密度関数は

$$
\begin{equation}
f(t;k,\theta) =  t^{k-1}\frac{e^{-t/\theta}}{\theta^k\Gamma(k)}
\end{equation}
$$

と表される．ただし，$t > 0$であり， 2つの母数は$k, \theta > 0$である．また，$\Gamma (\cdot)$ はガンマ関数であり，

$$
\begin{equation}
\Gamma (k)=\int _{0}^{\infty }x^{k-1}e^{-x}\,dx
\end{equation}
$$

と定義される．ガンマ分布の平均は$k\theta$だが，発火率はISIの平均の逆数なので，$\lambda=1/k\theta$となる．また，$k=1$のとき，ガンマ分布は指数分布となる．さらに$k$が正整数のとき，ガンマ分布はアーラン分布となる．

ガンマ過程モデルの実装はポアソン過程モデルのISIを累積する手法と同様に書くことができる．ただしこの時，`Distributions.jl`を用いる．基本的には`randexp(shape)`を`rand(Gamma(a,b), shape)`に置き換えればよい (もちろん多少の修正は必要とする)．

なお，前述したようにガンマ過程モデルの方がポアソン過程モデルよりも皮質ニューロンのモデルとしては優れているが，入力画像のエンコーディングをガンマ過程モデルにすることでSNNの認識精度が向上するかどうかはまだ十分に研究されていない．また，{cite:p}`Deger2012-ai`ではPPDやガンマ過程の重ね合わせによるスパイク列を生成するアルゴリズムを考案している．

### 発火率の推定
神経細胞がある時刻 $t_i$ にスパイクを発生させたとき，そのスパイク列は**ディラックのデルタ関数**を用いて

$$
S(t) = \sum_{i} \delta(t - t_i)
$$

と記述される．ここで，$\delta(t - t_i)$ は時刻 $t_i$ における理想的なスパイク（瞬間的な事象）を表しており，$\int_{-\infty}^{\infty} \delta(t - t_i) dt = 1$ を満たす．このスパイク列から滑らかな発火率を得るには，ある**時間窓** $h(t)$ による平滑化（畳み込み）を行う：

$$
r(t) = (S * h)(t) = \int_{-\infty}^{\infty} S(\tau) h(t - \tau) d\tau = \sum_i h(t - t_i)
$$

この $r(t)$ が**時刻 $t$ における発火率**を定義する関数である．

時間窓関数 $h(t)$ としては，正規分布型（ガウスカーネル）や指数関数減衰型などがしばしば用いられる：

- ガウス型： $h(t) = \frac{1}{\sqrt{2\pi \sigma^2}} \exp\left( -\frac{t^2}{2\sigma^2} \right)$
- 指数減衰型： $h(t) = \frac{1}{\tau} \exp\left( -\frac{t}{\tau} \right) \cdot \Theta(t)$（\(\Theta(t)\) はステップ関数）

一方，神経集団の統計的性質を扱う場合には，**スパイク列を確率的な点過程**として扱い，その条件付き強度関数（conditional intensity function）を発火率とみなす．すなわち，あるニューロンのスパイク列が条件付きポアソン過程であるとき，発火率 $\lambda(t)$ はその時点でスパイクが起こる**瞬間的な確率密度**として定義される：

$$
\lambda(t) = \lim_{\Delta t \to 0} \frac{\mathbb{E}[N(t + \Delta t) - N(t) \mid \mathcal{H}_t]}{\Delta t}
$$

ここで，$\mathcal{H}_t$ は時刻 $t$ までのスパイク履歴，$N(t)$ は時刻 $t$ までのスパイク数である．この形式は発火率をより確率論的に捉えた定式化であり，LNPモデルやGLMなどで重要である．

### ポアソン過程の拡散近似
神経活動には**ノイズ**（neuronal noise）が常に存在しており、神経モデルにおいてもこれを考慮する必要がある。そのため、ダイナミクスにノイズを加えることがある。たとえば、Leaky Integrate-and-Fire（LIF）モデルにおける膜電位の力学にノイズを加える場合を考える。ノイズ$\xi(t)$を平均$\tilde{\mu}$、分散$\tilde{\sigma}^2$の正規分布$\mathcal{N}(\tilde{\mu}, \tilde{\sigma}^2)$に従うガウシアンノイズとすると、膜電位$V_m(t)$の時間発展は次式で記述される：

$$
\tau_m \frac{dV_m(t)}{dt} = -(V_m(t) - V_\text{rest}) + R_m I(t) + \xi(t)
$$

このように、線形のドリフト項$-(V_m(t) - V_\text{rest})$とガウシアンノイズ項$\xi(t)$を含む確率微分方程式（stochastic differential equation; SDE）で表される確率過程は、**Ornstein–Uhlenbeck（OU）過程** と呼ばれる。ノイズ$\xi(t)$が標準正規分布$\mathcal{N}(0, 1)$に従うホワイトノイズ$\eta(t)$を用いて $\xi(t) = \tilde{\mu} + \tilde{\sigma} \eta(t)$ と表すこともできる。

さらに、$\xi(t)$が発火率$\lambda$のポアソン過程に従う場合を考える。シナプス前細胞の数を$N_\text{pre}$、$i$番目のシナプスにおけるシナプス強度に比例する定数を$J_i$とすると、ノイズの平均と分散はそれぞれ$\tilde{\mu} = \langle J_i \rangle N_\text{pre} \cdot \lambda$、$\tilde{\sigma}^2 = \langle J_i^2 \rangle N_\text{pre} \cdot \lambda$と書ける。ただし、$\langle \cdot \rangle$は平均を意味する。このような連続的なガウス過程でポアソン入力を近似する手法を**拡散近似**（diffusion approximation）と呼び、これは**Campbellの定理**に基づいて導かれる。

このような確率微分方程式を数値的にシミュレーションするためには、時間離散化が必要となるが、その際には注意が必要である。たとえば、ドリフト項を省略し、ノイズ項のみを残した場合、

$$
\tau_m \frac{dV_m(t)}{dt} = \xi(t)
$$

となる。この式を時間ステップ$\Delta t$でEuler法により離散化すると、

$$
V_m(t + \Delta t) = V_m(t) + \frac{1}{\tau_m} \xi_1(t)
$$

と書ける。ここで、時間ステップを$\Delta t$から$\Delta t/2$に変更して同様に離散化すると、

$$
\begin{aligned}
V_m(t + \Delta t) &= V_m(t + \Delta t/2) + \frac{1}{\tau_m} \xi_1(t) \\
&= V_m(t) + \frac{1}{\tau_m} \left[ \xi_1(t) + \xi_2(t) \right]
\end{aligned}
$$

となる。ノイズ項$\xi_1(t)$と$\xi_2(t)$は互いに独立と仮定すると、それぞれの標準偏差は$\tilde{\sigma}/\tau_m$であり、その和$\xi_1(t) + \xi_2(t)$の分散は$2\tilde{\sigma}^2$、すなわち標準偏差は$\sqrt{2} \tilde{\sigma}/\tau_m$となる。これは時間ステップの取り方によってノイズ項の大きさが変化することを意味しており、正確なシミュレーションのためには問題となる。したがって、時間ステップに依存しないようノイズ項をスケーリングする必要があり、そのためにはノイズに$\sqrt{\Delta t}$を掛けることで対処できる。すなわち、離散化式は以下のように修正するのが望ましい：

$$
V_m(t + \Delta t) = V_m(t) + \frac{\sqrt{\Delta t}}{\tau_m} \xi_1(t)
$$

このように修正することで、時間ステップに依存しない安定なノイズスケーリングが可能となる。このように確率微分方程式をEuler法で離散化する方法は、**Euler–Maruyama法**と呼ばれる\footnote{他の離散化手法としては、Milstein法なども存在する。}。